---
description: Bili2MP4 轻量化单体应用规范（Rust + Tauri）
alwaysApply: true
---

# Bili2MP4 项目规范

## 项目定位
本地轻量化 B 站缓存视频转换小工具（macOS），基于 GPAC MP4Box 将 m4s 无损封装为标准 MP4。

## 架构原则
- **单体应用**：GUI 与业务逻辑同一进程，无 C/S、无 RPC、无独立服务端
- **Tauri**：Rust 后端 + Web 前端，通过 Commands 直接调用，进度通过 `emit` 推送
- **即开即用**：双击启动，关闭即退出，无后台常驻
- **轻量依赖**：Rust 标准库 + serde + Tauri + MP4Box

## 技术栈
- **语言**：Rust
- **GUI**：Tauri（Rust + HTML/JS 或轻量前端）
- **转换**：GPAC MP4Box（捆绑静态版，遵循 LGPL）
- **JSON**：serde + serde_json

## 目录结构
- `src/`：前端资源
- `src-tauri/src/`：Rust 后端，含 cache、convert、filemgr、config 模块
- `src-tauri/Cargo.toml`：依赖配置
- `resources/`：MP4Box 等捆绑资源

## 默认缓存路径
- `~/Movies/bilibili/`（小写，新版客户端）
- `~/Movies/Bilibili/`
- `~/Library/Containers/com.bilibili.bilibili/Data/Download/`

## 缓存格式
- **元数据**：`entry.json`（旧版）或 `videoInfo.json` / `.videoInfo`（新版 macOS）
- **m4s 命名**：`video.m4s`/`audio.m4s` 或 `{itemId}-1-{codec}.m4s`（codec 大者为视频）
- **新版 m4s 头部**：前 9 字节为 `0x30` 填充，转换前需去除

## 核心约束
- 转换必须无损（流复制，不重新编码）
- 支持 macOS 11.0+，Intel 与 Apple Silicon
- 文件名需处理中文、emoji 及非法字符（`/`、`:` 等）
