---
description: MP4Box 转换与 m4s 处理规范
globs: "src-tauri/src/convert/**/*.rs"
alwaysApply: false
---

# MP4Box 转换规范

## 优先命令（标准或已去头部 m4s）
```bash
MP4Box -add video.m4s#video -add audio.m4s#audio -new output.mp4 -itags tool=Bili2MP4
```

## 9 字节头部处理（新版 B 站 macOS 缓存）
- 若 MP4Box 报 `Invalid IsoMedia File` 或 `Unknown top-level box type 0000`，表示 m4s 含 9 字节 `0x30` 填充
- 转换前需去除：`tail -c +10` 或 Rust 中读取时 skip 9 字节，写入临时文件再交给 MP4Box
- 也可在内存中去头部后通过管道传递（若 MP4Box 支持 stdin）

## 备选命令（fMP4 碎片化格式）
若直接添加失败，尝试 `:raw` 模式：
```bash
MP4Box -add video.m4s#video:raw -add audio.m4s#audio:raw -new output.mp4
```

## m4s 定位与识别
- **旧版**：`64/`、`80/` 等子目录下的 `video.m4s`、`audio.m4s`
- **新版**：同目录下 `{itemId}-1-{codec}.m4s`，按 codec 数字降序，大者为视频、小者为音频
- 转换前校验 `Path::exists()` 且可读

## 执行方式
- 使用 `std::process::Command` 启动子进程
- 实时捕获 stdout/stderr，解析进度，通过 `app.emit("convert-progress", payload)` 更新 UI
- 取消：使用 `Arc<AtomicBool>` 共享取消标志
