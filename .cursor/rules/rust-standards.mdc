---
description: Rust 编码规范与错误处理
globs: "**/*.rs"
alwaysApply: false
---

# Rust 编码规范

## 错误处理
- 使用 `Result<T, E>` 或 `anyhow::Result`，不吞掉错误
- 自定义错误类型使用 `thiserror` 的 `#[derive(Error)]`
- 业务异常返回友好提示；转换失败时记录日志，继续下一项而非 panic

```rust
// ✅ GOOD
#[derive(Debug, thiserror::Error)]
enum ConvertError {
    #[error("转换失败: {0}")]
    Io(#[from] std::io::Error),
    #[error("MP4Box 执行失败")]
    Mp4BoxFailed,
}
```

## 模块化
- 核心逻辑放在 src-tauri/src 各子模块（cache、convert、filemgr、config）
- 转换、扫描、文件管理分离，便于单元测试
- 关键函数（如 `parse_entry`、`parse_video_info`、`convert_one`）需 `#[cfg(test)]` 单元测试，覆盖率 ≥ 70%

## 中文与路径
- 源码 UTF-8 编码
- 用户可见字符串使用中文或 i18n 准备
- 文件名清理：使用 `sanitize_filename` 或过滤 `/\:*?"<>|`，保留中文
